name: Deploy to EC2

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 10  # ì „ì²´ job íƒ€ì„ì•„ì›ƒ

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22.16.0'

      - name: Install pnpm
        run: npm install -g pnpm

      - name: Debug connection info
        run: |
          echo "ğŸ” Connection Details:"
          echo "Host: ${{ secrets.EC2_HOST }}"
          echo "Username: ${{ secrets.EC2_USER }}"
          echo "Timestamp: $(date)"

      - name: Test SSH Connection
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          timeout: 60s           # SSH ì—°ê²° íƒ€ì„ì•„ì›ƒ
          command_timeout: 5s    # ëª…ë ¹ ì‹¤í–‰ íƒ€ì„ì•„ì›ƒ (í…ŒìŠ¤íŠ¸ìš©)
          debug: true           # ìƒì„¸ ë¡œê·¸ ì¶œë ¥
          script: |
            echo "âœ… SSH Connection successful!"
            echo "ğŸ–¥ï¸  Server info: $(uname -a)"
            echo "ğŸ‘¤ Current user: $(whoami)"
            echo "ğŸ“‚ Current directory: $(pwd)"
            echo "ğŸ•’ Server time: $(date)"

      - name: Deploy to EC2 via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          timeout: 120s          # SSH ì—°ê²° íƒ€ì„ì•„ì›ƒ (ë°°í¬ìš©)
          command_timeout: 10m   # ëª…ë ¹ ì‹¤í–‰ íƒ€ì„ì•„ì›ƒ (ë°°í¬ëŠ” ì‹œê°„ì´ ì˜¤ë˜ ê±¸ë¦¼)
          debug: true           # ìƒì„¸ ë¡œê·¸ ì¶œë ¥
          script: |
            set -e  # ì—ëŸ¬ ë°œìƒì‹œ ì¦‰ì‹œ ì¤‘ë‹¨
            
            echo "ğŸš€ Starting deployment process..."
            echo "ğŸ“… Deployment started at: $(date)"
            
            # í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ í™•ì¸
            echo "ğŸ“‚ Checking project directory..."
            if [ ! -d "/home/ec2-user/DocHub" ]; then
              echo "âŒ Project directory not found!"
              exit 1
            fi
            
            cd /home/ec2-user/DocHub
            echo "âœ… Changed to project directory: $(pwd)"
            
            # Git ìƒíƒœ í™•ì¸
            echo "ğŸ”„ Checking git status..."
            git status
            
            # ìµœì‹  ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
            echo "ğŸ“¥ Pulling latest code..."
            git pull origin main
            
            # ë°±ì—”ë“œ ë””ë ‰í† ë¦¬ë¡œ ì´ë™
            echo "ğŸ“‚ Moving to backend directory..."
            if [ ! -d "apps/backend" ]; then
              echo "âŒ Backend directory not found!"
              exit 1
            fi
            
            cd apps/backend
            echo "âœ… Changed to backend directory: $(pwd)"
            
            # pnpm ì„¤ì¹˜ ìƒíƒœ í™•ì¸
            echo "ğŸ“¦ Checking pnpm installation..."
            if ! command -v pnpm &> /dev/null; then
              echo "âŒ pnpm not found, installing..."
              npm install -g pnpm
            else
              echo "âœ… pnpm found: $(pnpm --version)"
            fi
            
            # ì˜ì¡´ì„± ì„¤ì¹˜
            echo "ğŸ“¦ Installing dependencies..."
            pnpm install --production
            
            # PM2 ìƒíƒœ í™•ì¸
            echo "ğŸ”§ Checking PM2 status..."
            if ! command -v pm2 &> /dev/null; then
              echo "âŒ PM2 not found, installing..."
              pnpm add -g pm2
            else
              echo "âœ… PM2 found: $(pm2 --version)"
            fi
            
            # í˜„ì¬ ì‹¤í–‰ ì¤‘ì¸ ì•± í™•ì¸
            echo "ğŸ“Š Current PM2 processes:"
            pm2 list || echo "No PM2 processes running"
            
            # ì•± ì¬ì‹œì‘ ë˜ëŠ” ì‹œì‘
            echo "ğŸ”„ Restarting application..."
            if pm2 describe app > /dev/null 2>&1; then
              echo "â™»ï¸  Restarting existing app..."
              pm2 restart app
            else
              echo "ğŸ†• Starting new app..."
              if [ -f "app.js" ]; then
                pm2 start app.js --name app
              elif [ -f "server.js" ]; then
                pm2 start server.js --name app
              elif [ -f "index.js" ]; then
                pm2 start index.js --name app
              else
                echo "âŒ No main file found (app.js, server.js, index.js)"
                exit 1
              fi
            fi
            
            # ë°°í¬ í›„ ìƒíƒœ í™•ì¸
            echo "ğŸ“Š Post-deployment status:"
            pm2 list
            pm2 logs app --lines 10 || echo "No logs available"
            
            echo "âœ… Deployment completed successfully!"
            echo "ğŸ“… Deployment finished at: $(date)"

      - name: Verify Deployment
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          timeout: 30s
          command_timeout: 10s
          script: |
            echo "ğŸ” Verifying deployment..."
            
            # ì„œë²„ ìƒíƒœ í™•ì¸
            if pm2 describe app > /dev/null 2>&1; then
              echo "âœ… App is running in PM2"
              pm2 show app
            else
              echo "âŒ App not found in PM2"
              exit 1
            fi
            
            # í¬íŠ¸ í™•ì¸ (3000ë²ˆ í¬íŠ¸ ì˜ˆì‹œ)
            if netstat -tlnp | grep :3000 > /dev/null 2>&1; then
              echo "âœ… App is listening on port 3000"
            else
              echo "âš ï¸  App might not be listening on port 3000"
            fi
            
            echo "ğŸ‰ Verification completed!"

  # ì‹¤íŒ¨ì‹œ ì•Œë¦¼ (ì„ íƒì‚¬í•­)
  notify-on-failure:
    runs-on: ubuntu-latest
    needs: deploy
    if: failure()
    steps:
      - name: Notify deployment failure
        run: |
          echo "âŒ Deployment failed!"
          echo "Please check the logs above for details."